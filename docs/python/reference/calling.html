

<!DOCTYPE html>
<html class="writer-html5" lang="ja" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Python の関数とメソッドの呼び出し &mdash; Boost.Python（日本語訳）  ドキュメント</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="Boost.Python における pickle のサポート" href="pickle.html" />
    <link rel="prev" title="トピック" href="topics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Boost.Python（日本語訳）
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目次</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">リリースノート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">チュートリアル</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building.html">ビルドとテスト</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../reference.html">リファレンスマニュアル</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="concepts.html">コンセプト</a></li>
<li class="toctree-l2"><a class="reference internal" href="components.html">高水準コンポーネント</a></li>
<li class="toctree-l2"><a class="reference internal" href="objects.html">オブジェクトラッパ</a></li>
<li class="toctree-l2"><a class="reference internal" href="functions.html">関数の呼び出しと作成</a></li>
<li class="toctree-l2"><a class="reference internal" href="conversion.html">Python との型変換</a></li>
<li class="toctree-l2"><a class="reference internal" href="embedding.html">組み込み</a></li>
<li class="toctree-l2"><a class="reference internal" href="utility.html">ユーティリティとインフラストラクチャ</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="topics.html">トピック</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Python の関数とメソッドの呼び出し</a></li>
<li class="toctree-l3"><a class="reference internal" href="pickle.html">Boost.Python における pickle のサポート</a></li>
<li class="toctree-l3"><a class="reference internal" href="indexing.html">添字アクセスのサポート</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../glossary.html">用語</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">設定に関する情報</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">用語</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support.html">サポートリソース</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">よくある質問と回答</a></li>
<li class="toctree-l1"><a class="reference internal" href="../numpy/index.html">Boost.Python（NumPy）</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../platforms.html">動作を確認したプラットフォームとコンパイラ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects.html">Boost.Python を使用しているプロジェクト</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../internals.html">Boost.Python の裏側</a></li>
<li class="toctree-l1"><a class="reference internal" href="../news.html">新着情報・変更履歴</a></li>
<li class="toctree-l1"><a class="reference internal" href="../todo.html">TODO リスト</a></li>
<li class="toctree-l1"><a class="reference internal" href="../progress_reports.html">LLNL 進捗レポート</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgements.html">謝辞</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Boost.Python（日本語訳）</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../reference.html">リファレンスマニュアル</a> &raquo;</li>
        
          <li><a href="topics.html">トピック</a> &raquo;</li>
        
      <li>Python の関数とメソッドの呼び出し</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/reference/calling.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="python">
<h1>Python の関数とメソッドの呼び出し<a class="headerlink" href="#python" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="contents local topic" id="id1">
<ul class="simple">
<li><p><a class="reference internal" href="#v2-calling-introduction" id="id9">はじめに</a></p></li>
<li><p><a class="reference internal" href="#v2-calling-argument-handling" id="id10">引数の処理</a></p></li>
<li><p><a class="reference internal" href="#v2-calling-result-handling" id="id11">戻り値の処理</a></p></li>
<li><p><a class="reference internal" href="#v2-calling-rationale" id="id12">根拠</a></p></li>
</ul>
</div>
<div class="section" id="v2-calling-introduction">
<span id="id2"></span><h2><a class="toc-backref" href="#id9">はじめに</a><a class="headerlink" href="#v2-calling-introduction" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Python 関数を保持する <a class="reference internal" href="object.html#_CPPv4N5boost6python6objectE" title="boost::python::object"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">object</span></code></a> インスタンス <code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">f</span></code> が与えられたとき、C++ からその関数を呼び出す最も簡単な方法は、単にその関数呼び出し演算子を起動することである。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="s">&quot;tea&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">// Python の f(&#39;tea&#39;, 4, 2) と同じ</span>
</pre></div>
</div>
<p>また、当然のことながら <a class="reference internal" href="object.html#_CPPv4N5boost6python6objectE" title="boost::python::object"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">object</span></code></a> インスタンス <code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">x</span></code> のメソッドを呼び出すには対応する属性の関数呼び出し演算子を使用する。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">&quot;tea&quot;</span><span class="p">)(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// Python の x.tea(4, 2) と同じ</span>
</pre></div>
</div>
<p><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">object</span></code> インスタンスがない場合、<code class="xref c c-type docutils literal notranslate"><span class="pre">PyObject*</span></code> に対して Python の関数およびメソッドを呼び出すために、Boost.Python は 2 種類の関数テンプレート <a class="reference internal" href="call.html#_CPPv4I0DpEN5boost6python4callE1RP8PyObjectRK4Args" title="boost::python::call"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">call</span></code></a> および <a class="reference internal" href="call_method.html#_CPPv4I0DpEN5boost6python11call_methodE1RP8PyObjectPKcRK4Args" title="boost::python::call_method"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">call_method</span></code></a> を提供している。Python の関数オブジェクト（または Python の呼び出し可能オブジェクト）を呼び出すインターフェイスは次のようなものである。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">call</span><span class="o">&lt;</span><span class="n">ResultType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">callable_object</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">...</span> <span class="n">aN</span><span class="p">);</span>
</pre></div>
</div>
<p>Python オブジェクトのメソッド呼び出しも同様に簡単である。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">call_method</span><span class="o">&lt;</span><span class="n">ResultType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">self_object</span><span class="p">,</span> <span class="s">&quot;method-name&quot;</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">...</span> <span class="n">aN</span><span class="p">);</span>
</pre></div>
</div>
<p>この比較的低水準なインターフェイスは、Python でオーバーライド可能な C++ 仮想関数を実装するときに使用する。</p>
</div>
<div class="section" id="v2-calling-argument-handling">
<span id="id3"></span><h2><a class="toc-backref" href="#id10">引数の処理</a><a class="headerlink" href="#v2-calling-argument-handling" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>引数はその型に従って Python に変換する。既定では引数 <code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">a1</span></code>...<code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">aN</span></code> は新しい Python オブジェクトにコピーされるが、<a class="reference internal" href="ptr.html#_CPPv4I0EN5boost6python3ptrE15pointer_wrapperI1TE1T" title="boost::python::ptr"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">ptr</span></code></a> および <a class="reference external" href="http://www.boost.org/libs/bind/ref.html">ref()</a> を使用してこの振る舞いを上書きすることができる。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">X</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
   <span class="p">...</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">apply</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span> <span class="n">callable</span><span class="p">,</span> <span class="n">X</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
   <span class="c1">// callable を呼び出し、x への参照を保持する Python オブジェクトを渡す</span>
   <span class="n">boost</span><span class="o">::</span><span class="n">python</span><span class="o">::</span><span class="n">call</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="n">callable</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>以下の表において <code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">x</span></code> は実際の引数オブジェクトであり、<code class="samp docutils literal notranslate"><em><span class="pre">cv</span></em></code> は省略可能な CV 指定子（<code class="docutils literal notranslate"><span class="pre">const</span></code> 、<code class="docutils literal notranslate"><span class="pre">volatile</span></code> あるいは <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">volatile</span></code>）である。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>引数の型</p></th>
<th class="head"><p>振る舞い</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">T</span> <span class="pre">cv&amp;</span></code> 、<code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">T</span> <span class="pre">cv</span></code></p></td>
<td><p><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">T</span></code> を返すラップした C++ 関数の戻り値と同じ方法で Python 引数を作成する。<code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">T</span></code> がクラス型の場合、通常は <code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">x</span></code> を新しい Python オブジェクト内にコピー構築する。</p>
</td>
</tr>
<tr class="row-odd"><td><p><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">T*</span></code></p></td>
<td><p><code class="xref cpp cpp-expr docutils literal notranslate"><span class="pre">x</span> <span class="pre">==</span> <span class="pre">0</span></code> の場合、Python 引数は <a class="reference external" href="http://docs.python.jp/2/library/stdtypes.html#bltin-null-object">None</a> である。それ以外の場合、<code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">T</span></code> を返すラップする C++ 関数の戻り値と同じ方法で Python 引数を作成する。<code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">T</span></code> がクラス型の場合、通常は <code class="xref cpp cpp-expr docutils literal notranslate"><span class="pre">*</span><span class="pre">x</span></code> を新しい Python オブジェクト内にコピー構築する。</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="http://www.boost.org/libs/bind/ref.html">boost::reference_wrapper&lt;&gt;</a></p></td>
<td><p>Python の引数は（コピーではなく）<code class="xref cpp cpp-expr docutils literal notranslate"><span class="pre">x</span><span class="pre">.</span><span class="pre">get</span><span class="pre">(</span><span class="pre">)</span></code> へのポインタを持つ。注意：結果のオブジェクトへの参照を保持する Python コードが <code class="xref cpp cpp-expr docutils literal notranslate"><span class="pre">*</span><span class="pre">x</span><span class="pre">.</span><span class="pre">get</span><span class="pre">(</span><span class="pre">)</span></code> の寿命を超えて存在しないようにしないと、<strong>クラッシュする！</strong></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="ptr.html#_CPPv4I0EN5boost6python15pointer_wrapperE" title="boost::python::pointer_wrapper"><code class="xref cpp cpp-struct docutils literal notranslate"><span class="pre">pointer_wrapper&lt;T&gt;</span></code></a></p></td>
<td><p><code class="xref cpp cpp-expr docutils literal notranslate"><span class="pre">x</span><span class="pre">.</span><span class="pre">get</span><span class="pre">(</span><span class="pre">)</span> <span class="pre">==</span> <span class="pre">0</span></code> の場合、Python 引数は <a class="reference external" href="http://docs.python.jp/2/library/stdtypes.html#bltin-null-object">None</a> である。それ以外の場合、Python の引数は（コピーではなく）<code class="xref cpp cpp-expr docutils literal notranslate"><span class="pre">x</span><span class="pre">.</span><span class="pre">get</span><span class="pre">(</span><span class="pre">)</span></code> へのポインタを持つ。注意：結果のオブジェクトへの参照を保持する Python コードが <code class="xref cpp cpp-expr docutils literal notranslate"><span class="pre">*</span><span class="pre">x</span><span class="pre">.</span><span class="pre">get</span><span class="pre">(</span><span class="pre">)</span></code> の寿命を超えて存在しないようにしないと、<strong>クラッシュする！</strong></p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="v2-calling-result-handling">
<span id="id5"></span><h2><a class="toc-backref" href="#id11">戻り値の処理</a><a class="headerlink" href="#v2-calling-result-handling" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>大抵の場合 <code class="xref cpp cpp-expr docutils literal notranslate"><a class="reference internal" href="call.html#_CPPv4I0DpEN5boost6python4callE1RP8PyObjectRK4Args" title="boost::python::call"><span class="pre">call</span></a><span class="pre">&lt;</span><span class="pre">ResultType</span><span class="pre">&gt;</span><span class="pre">(</span><span class="pre">)</span></code> および <code class="xref cpp cpp-expr docutils literal notranslate"><a class="reference internal" href="call_method.html#_CPPv4I0DpEN5boost6python11call_methodE1RP8PyObjectPKcRK4Args" title="boost::python::call_method"><span class="pre">call_method</span></a><span class="pre">&lt;</span><span class="pre">ResultType</span><span class="pre">&gt;</span><span class="pre">(</span><span class="pre">)</span></code> は、<code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">ResultType</span></code> に対して登録したすべての lvalue および rvalue の <code class="docutils literal notranslate"><span class="pre">from_python</span></code> 変換器を利用し、結果のコピーである <code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">ResultType</span></code> を返す。しかしながら <code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">ResultType</span></code> がポインタか参照型の場合、Boost.Python は lvalue の変換器のみを探索する。懸垂ポインタおよび参照を避けるため、結果の Python オブジェクトの参照カウントが 1 の場合は例外を投げる。</p>
</div>
<div class="section" id="v2-calling-rationale">
<span id="id6"></span><h2><a class="toc-backref" href="#id12">根拠</a><a class="headerlink" href="#v2-calling-rationale" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>通常 <code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">a1</span></code>...<code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">aN</span></code> に対応する Python の引数を得るには、それぞれについて新しい Python オブジェクトを作成しなければならない。C++ オブジェクトをその Python オブジェクトにコピーすべきだろうか、あるいは Python オブジェクトが単に C++ オブジェクトへの参照かポインタを保持すべきだろうか。大抵の場合、呼び出される関数はどこかに行ってしまった Python オブジェクトへの参照を保持する可能性があるため、後者の方法は安全ではない。C++ オブジェクトを破壊した後に Python オブジェクトを使用すると、Python がクラッシュする。</p>
<p>Python 側のユーザがインタープリタのクラッシュについて気を払うべきでないという原理を踏まえ、既定の振る舞いは C++ オブジェクトをコピーすることとなっており、コピーを行わない振る舞いはユーザが直接 <code class="xref cpp cpp-expr docutils literal notranslate"><span class="pre">a1</span></code> と書く代わりに <a class="reference external" href="http://www.boost.org/libs/ref.html">boost::ref</a><code class="code docutils literal notranslate"><span class="pre">(a1)</span></code> とした場合のみ認められる。こうすることで、少なくとも「意図せず」危険な振る舞いを遭遇することはない。コピーを伴わない（「参照」による）振る舞いは通常、クラス型でのみ利用可能であり、それ以外で使用すると実行時に Python の例外を送出して失敗する<a class="footnote-reference brackets" href="#id8" id="id7">1</a>ことも付記しておく。</p>
<p>しかしながらポインタ型が問題となる。方法の 1 つはいずれかの <code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">aN</span></code> がポインタ型である場合にコンパイルを拒絶することである。何といってもユーザは「値渡し」として <code class="xref cpp cpp-expr docutils literal notranslate"><span class="pre">*</span><span class="pre">aN</span></code> を渡すことができ、<code class="xref cpp cpp-expr docutils literal notranslate"><span class="pre">ref</span><span class="pre">(</span><span class="pre">*</span><span class="pre">aN</span><span class="pre">)</span></code> で参照渡しの振る舞いを示すことができる。しかしこれでは null ポインタから <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code> への変換で問題が起こる。null ポインタ値を参照剥がしすることは違法である。</p>
<p>折衷案として私が下した決断は以下のとおりだ：</p>
<ol class="arabic simple">
<li><p>既定の振る舞いは値渡しとする。非 null ポインタを渡すと、参照先が新しい Python オブジェクトにコピーされる。それ以外の場合、対応する Python 引数は <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code> である。</p></li>
<li><p>参照渡しの振る舞いが必要な場合は、<code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">aN</span></code> がポインタであれば <code class="xref cpp cpp-expr docutils literal notranslate"><a class="reference internal" href="ptr.html#_CPPv4I0EN5boost6python3ptrE15pointer_wrapperI1TE1T" title="boost::python::ptr"><span class="pre">ptr</span></a><span class="pre">(</span><span class="pre">aN</span><span class="pre">)</span></code> を、そうでなければ <code class="xref cpp cpp-expr docutils literal notranslate"><span class="pre">ref</span><span class="pre">(</span><span class="pre">aN</span><span class="pre">)</span></code> を使用する。<code class="xref cpp cpp-expr docutils literal notranslate"><a class="reference internal" href="ptr.html#_CPPv4I0EN5boost6python3ptrE15pointer_wrapperI1TE1T" title="boost::python::ptr"><span class="pre">ptr</span></a><span class="pre">(</span><span class="pre">aN</span><span class="pre">)</span></code> に null ポインタを渡すと、対応する Python 引数は <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code> である。</p></li>
</ol>
<p>戻り値についても類似の問題がある。<code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">ResultType</span></code> にポインタ型か参照型を認めてしまうと、参照先のオブジェクトの寿命はおそらく Python オブジェクトに管理されることになる。この Python オブジェクトが破壊されるとポインタは懸垂する。<code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">ResultType</span></code> が <code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">char</span> <span class="pre">const*</span></code> の場合、特に問題は深刻である。対応する Python の String オブジェクトは一般に参照カウントが 1 であり、つまり <code class="xref cpp cpp-expr docutils literal notranslate"><a class="reference internal" href="call.html#_CPPv4I0DpEN5boost6python4callE1RP8PyObjectRK4Args" title="boost::python::call"><span class="pre">call</span></a><span class="pre">&lt;</span><span class="pre">char</span> <em class="property"><span class="pre">const</span></em><span class="pre">*</span><span class="pre">&gt;</span><span class="sig-paren">(</span><span class="pre">...</span><span class="sig-paren">)</span></code> が返った直後にポインタは懸垂する。</p>
<p>以前の Boost.Python v1 は <code class="xref cpp cpp-expr docutils literal notranslate"><a class="reference internal" href="call.html#_CPPv4I0DpEN5boost6python4callE1RP8PyObjectRK4Args" title="boost::python::call"><span class="pre">call</span></a><span class="pre">&lt;</span><span class="pre">char</span> <em class="property"><span class="pre">const</span></em><span class="pre">*</span><span class="pre">&gt;</span><span class="pre">(</span><span class="pre">)</span></code> のコンパイルを拒絶することでこの問題に対処したが、これは極端でありかつ何の解決にもならない。極端というのは、所有する Python の文字列オブジェクト（例えば Python のクラス名である場合）が呼び出しを超えて生存する可能性があるためである。また、他の型のポインタや参照の戻り値についてもまったく同様の問題があるため、結局は解決にならないわけである。</p>
<p>Boost.Python v2 では次のように対処した。</p>
<ol class="arabic simple">
<li><p>コールバックの <code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">const</span> <span class="pre">char*</span></code> 戻り値型に対するコンパイル時の制限を除去した。</p></li>
<li><p><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">U</span></code> がポインタ型か参照型の場合、戻り値の Python オブジェクトの参照カウントが 1 である場合を検出し、<code class="xref cpp cpp-expr docutils literal notranslate"><a class="reference internal" href="call.html#_CPPv4I0DpEN5boost6python4callE1RP8PyObjectRK4Args" title="boost::python::call"><span class="pre">call</span></a><span class="pre">&lt;</span><span class="pre">U</span><span class="pre">&gt;</span><span class="sig-paren">(</span><span class="pre">...</span><span class="sig-paren">)</span></code> 内で例外を投げる。</p></li>
</ol>
<p>ユーザは <code class="xref cpp cpp-expr docutils literal notranslate"><a class="reference internal" href="call.html#_CPPv4I0DpEN5boost6python4callE1RP8PyObjectRK4Args" title="boost::python::call"><span class="pre">call</span></a><span class="pre">&lt;</span><span class="pre">U</span><span class="pre">&gt;</span></code> 内で <code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">U</span></code> について明示的にポインタ、参照を指定しなければならないため安全であり、実行時の懸垂からも保護される。少なくとも <code class="xref cpp cpp-expr docutils literal notranslate"><a class="reference internal" href="call.html#_CPPv4I0DpEN5boost6python4callE1RP8PyObjectRK4Args" title="boost::python::call"><span class="pre">call</span></a><span class="pre">&lt;</span><span class="pre">U</span><span class="pre">&gt;</span><span class="sig-paren">(</span><span class="pre">...</span><span class="sig-paren">)</span></code> の呼び出しから抜け出すには十分である。</p>
<dl class="footnote brackets">
<dt class="label" id="id8"><span class="brackets"><a class="fn-backref" href="#id7">1</a></span></dt>
<dd><p><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">int</span></code> や <code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">char</span></code> のような非クラス型についてはコンパイル時に失敗させることも可能だろうが、それがこの制限を課す優れた方法であるか私にはよく分からない。</p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="pickle.html" class="btn btn-neutral float-right" title="Boost.Python における pickle のサポート" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="topics.html" class="btn btn-neutral float-left" title="トピック" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; 著作権 2020, exeal

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>